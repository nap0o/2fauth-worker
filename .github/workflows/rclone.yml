name: Backup D1 Database with Rclone

on:
  schedule:
    - cron: "0 5 * * *"
  workflow_dispatch:

jobs:
  backup-process:
    name: Secure Backup Pipeline
    runs-on: ubuntu-latest
    
    # å…¨å±€ç¯å¢ƒå˜é‡æ˜ å°„
    env:
      # --- Cloudflare ---
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_D1_DATABASE_ID: ${{ secrets.CLOUDFLARE_D1_DATABASE_ID }}
      
      # --- Encryption ---
      BACKUP_ENCRYPTION_KEY: ${{ secrets.BACKUP_ENCRYPTION_KEY }}
      
      # --- WebDAV ---
      WEBDAV_URL: ${{ secrets.WEBDAV_URL }}
      WEBDAV_USER: ${{ secrets.WEBDAV_USER }}
      WEBDAV_PASSWORD: ${{ secrets.WEBDAV_PASSWORD }}
      WEBDAV_VENDOR: ${{ secrets.WEBDAV_VENDOR || 'other' }}
      WEBDAV_BASE_PATH: ${{ secrets.WEBDAV_BASE_PATH || '2fauth-worker' }}
      
      # --- Google Drive ---
      GDRIVE_TOKEN: ${{ secrets.GDRIVE_TOKEN }}
      GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
      GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
      GDRIVE_ROOT_FOLDER_ID: ${{ secrets.GDRIVE_ROOT_FOLDER_ID }}
      
      # --- Retention Policy ---
      RETENTION_DAYS: ${{ secrets.BACKUP_RETENTION_DAYS || 30 }}
      
      # --- Tool Versions (ç¨³å®šæ€§æ ¸å¿ƒ) ---
      WRANGLER_VERSION: "3.57.1"

    steps:
      # STEP 1: ç¯å¢ƒåˆå§‹åŒ– (å·¥å…·å®‰è£…)
      - name: ğŸ› ï¸ Setup Tools
        uses: AnimMouse/setup-rclone@v1
        with:
          version: v1.66.0

      # STEP 2: é…ç½®æ³¨å…¥ä¸æ£€æŸ¥ (In-Memory Configuration)
      # è¿™æ˜¯ä¸€ä¸ªå…³é”®æ­¥éª¤ï¼šå®ƒæ£€æŸ¥å˜é‡ï¼Œå¹¶å°† Rclone é…ç½®ç›´æ¥å†™å…¥ GitHub ç¯å¢ƒï¼Œè€Œä¸ç”Ÿæˆæ–‡ä»¶
      - name: ğŸ›¡ï¸ Pre-flight Check & Config Injection
        id: config
        run: |
          # åˆå§‹åŒ–ç›®æ ‡åˆ—è¡¨
          TARGETS=""
          
          # --- 1. Cloudflare æ ¸å¿ƒæ£€æŸ¥ ---
          if [[ -z "$CLOUDFLARE_ACCOUNT_ID" || -z "$CLOUDFLARE_API_TOKEN" || -z "$CLOUDFLARE_D1_DATABASE_ID" ]]; then
            echo "::error::Missing Cloudflare credentials!"
            exit 1
          fi

          # --- 2. WebDAV åŠ¨æ€é…ç½® (Env Config Protocol) ---
          if [[ -n "$WEBDAV_URL" && -n "$WEBDAV_USER" && -n "$WEBDAV_PASSWORD" ]]; then
            echo "âœ… WebDAV Detected: Enabling..."
            TARGETS+="remote_webdav "
            
            # å°†é…ç½®æ³¨å…¥ç¯å¢ƒå˜é‡ï¼ŒRclone ä¼šè‡ªåŠ¨è¯†åˆ«åä¸º 'remote_webdav' çš„é…ç½®
            echo "RCLONE_CONFIG_REMOTE_WEBDAV_TYPE=webdav" >> $GITHUB_ENV
            echo "RCLONE_CONFIG_REMOTE_WEBDAV_URL=$WEBDAV_URL" >> $GITHUB_ENV
            echo "RCLONE_CONFIG_REMOTE_WEBDAV_VENDOR=$WEBDAV_VENDOR" >> $GITHUB_ENV
            echo "RCLONE_CONFIG_REMOTE_WEBDAV_USER=$WEBDAV_USER" >> $GITHUB_ENV
            # å®æ—¶åŠ å¯†å¯†ç å¹¶æ³¨å…¥
            OBSCURED=$(rclone obscure "$WEBDAV_PASSWORD")
            echo "RCLONE_CONFIG_REMOTE_WEBDAV_PASS=$OBSCURED" >> $GITHUB_ENV
          fi

          # --- 3. GDrive åŠ¨æ€é…ç½® (Env Config Protocol) ---
          if [[ -n "$GDRIVE_TOKEN" && -n "$GDRIVE_CLIENT_ID" && -n "$GDRIVE_CLIENT_SECRET" && -n "$GDRIVE_ROOT_FOLDER_ID" ]]; then
            echo "âœ… GDrive Detected: Enabling..."
            TARGETS+="remote_gdrive "
            
            echo "RCLONE_CONFIG_REMOTE_GDRIVE_TYPE=drive" >> $GITHUB_ENV
            echo "RCLONE_CONFIG_REMOTE_GDRIVE_SCOPE=drive" >> $GITHUB_ENV
            echo "RCLONE_CONFIG_REMOTE_GDRIVE_TOKEN=$GDRIVE_TOKEN" >> $GITHUB_ENV
            echo "RCLONE_CONFIG_REMOTE_GDRIVE_CLIENT_ID=$GDRIVE_CLIENT_ID" >> $GITHUB_ENV
            echo "RCLONE_CONFIG_REMOTE_GDRIVE_CLIENT_SECRET=$GDRIVE_CLIENT_SECRET" >> $GITHUB_ENV
            echo "RCLONE_CONFIG_REMOTE_GDRIVE_ROOT_FOLDER_ID=$GDRIVE_ROOT_FOLDER_ID" >> $GITHUB_ENV
          fi

          # --- ç†”æ–­æ£€æŸ¥ ---
          if [[ -z "$TARGETS" ]]; then
            echo "::error::No backup targets configured! Aborting."
            exit 1
          fi
          
          # è¾“å‡ºç›®æ ‡åˆ—è¡¨ä¾›åç»­ä½¿ç”¨
          echo "BACKUP_TARGETS=$TARGETS" >> $GITHUB_ENV

      # STEP 3: æ•°æ®ç”Ÿäº§ (å¯¼å‡ºã€å‹ç¼©ã€åŠ å¯†)
      - name: ğŸ“¦ Export & Encrypt Database
        run: |
          # å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ Wrangler
          npm install -g wrangler@${{ env.WRANGLER_VERSION }} --quiet

          # è·å–æ•°æ®åº“åç§°
          DB_NAME=$(npx wrangler d1 list --json | jq -r ".[] | select(.uuid == \"$CLOUDFLARE_D1_DATABASE_ID\") | .name")
          if [[ -z "$DB_NAME" ]]; then
             echo "::error::Could not resolve D1 Name from UUID."
             exit 1
          fi
          
          echo "ğŸš€ Exporting: $DB_NAME"
          npx wrangler d1 export "$DB_NAME" --remote --output=backup.sql
          
          echo "ğŸ—œï¸ Compressing..."
          gzip -9 backup.sql
          
          # ç”Ÿæˆæ–‡ä»¶å
          DATE=$(date +'%Y-%m-%d_%H-%M-%S')
          
          if [[ -n "$BACKUP_ENCRYPTION_KEY" ]]; then
            echo "ğŸ”’ Encrypting (AES-256)..."
            FILENAME="backup_${DATE}.sql.gz.enc"
            openssl enc -aes-256-cbc -salt -pbkdf2 -iter 100000 \
              -in backup.sql.gz -out "$FILENAME" -pass pass:"$BACKUP_ENCRYPTION_KEY"
          else
            echo "âš ï¸ Encryption skipped (Key not set)"
            FILENAME="backup_${DATE}.sql.gz"
            mv backup.sql.gz "$FILENAME"
          fi
          
          echo "FILENAME=$FILENAME" >> $GITHUB_ENV

      # STEP 4: æ•°æ®åˆ†å‘ (æ•…éšœéš”ç¦»å¾ªç¯)
      - name: ğŸš€ Distribute to Cloud
        run: |
          # ä»»ä½•å‘½ä»¤å¤±è´¥ä¸ç«‹å³é€€å‡ºï¼Œç”±é€»è¾‘æ§åˆ¶
          set +e 
          
          OVERALL_STATUS=0
          
          for target in $BACKUP_TARGETS; do
            echo "---------------------------------------------------"
            echo "ğŸ“¡ Processing Remote: [${target}]"
            
            # --- è·¯å¾„ç­–ç•¥ ---
            if [[ "$target" == "remote_webdav" ]]; then
              # WebDAV: æ˜¾å¼æ‹¼æ¥ Base Path
              DEST_PATH="${target}:${WEBDAV_BASE_PATH}/${FILENAME}"
              PURGE_PATH="${target}:${WEBDAV_BASE_PATH}/"
            else
              # GDrive: ä¾èµ– Root Folder IDï¼Œç›´æ¥å­˜æ ¹
              DEST_PATH="${target}:${FILENAME}"
              PURGE_PATH="${target}:"
            fi
            
            # --- 1. ä¸Šä¼  ---
            echo "   ğŸ“¤ Uploading..."
            rclone --config /dev/null copyto "$FILENAME" "$DEST_PATH" --retries 3
            
            if [ $? -ne 0 ]; then
              echo "::error::âŒ Failed to upload to $target"
              OVERALL_STATUS=1
              continue # è·³è¿‡å½“å‰ç›®æ ‡çš„åç»­æ­¥éª¤ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªç›®æ ‡
            fi
            
            # --- 2. æ¸…ç† ---
            echo "   ğŸ§¹ Pruning old backups (> ${RETENTION_DAYS}d)..."
            rclone --config /dev/null delete "$PURGE_PATH" --min-age ${RETENTION_DAYS}d -v
            
            if [ $? -ne 0 ]; then
               echo "::warning::âš ï¸ Cleanup failed for $target, but upload was successful."
               # æ¸…ç†å¤±è´¥ä¸ç®—æ ¸å¿ƒå¤±è´¥ï¼Œä¸ä¿®æ”¹ OVERALL_STATUS
            fi
            
            echo "   âœ… Success: $target"
          done
          
          echo "---------------------------------------------------"
          
          # æœ€ç»ˆæ ¹æ®æ•´ä½“çŠ¶æ€å†³å®š Job æ˜¯å¦æˆåŠŸ
          if [ $OVERALL_STATUS -ne 0 ]; then
            echo "::error::One or more backup targets failed."
            exit 1
          fi
          
          echo "ğŸ‰ All backup tasks completed successfully."